name: Train Model

on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'scripts/**'
      - 'requirements.txt'
      - 'data/**' # Ajout√© pour d√©clencher si les donn√©es CSV changent
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:

jobs:
  train:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        lfs: true # <--- OBLIGATOIRE pour t√©l√©charger les fichiers CSV r√©els

    - name: Pull LFS objects
      run: git lfs pull # <--- S√©curit√© suppl√©mentaire pour garantir le t√©l√©chargement

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Download Kaggle data
      env:
        KAGGLE_USERNAME: ${{ secrets.KAGGLE_USERNAME }}
        KAGGLE_KEY: ${{ secrets.KAGGLE_KEY }}
      run: python scripts/download_data.py || echo "‚ö†Ô∏è Data download failed"
    
    - name: STEP 1 - Data Loader Agent
      id: data_loader
      env:
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
      run: |
        echo "::group::üìä Data Loader Agent Output"
        python scripts/run_pipeline.py --train --no-submission
        echo "::endgroup::"
    
    - name: STEP 2 - Feature Engineer Agent
      id: feature_engineer
      run: |
        echo "::group::üìà Feature Engineer Agent Output"
        python -c "from pathlib import Path; print('‚úÖ Success') if Path('src/models/').exists() else print('‚ö†Ô∏è Missing')"
        echo "::endgroup::"
    
    - name: STEP 3 - Model Trainer Agent
      id: model_trainer
      run: |
        echo "::group::ü§ñ Model Trainer Agent Output"
        python -c "import joblib; from pathlib import Path; model_path = Path('src/models/baseline_model.pkl'); print(f'‚úÖ Loaded: {model_path}') if model_path.exists() else exit(1)"
        echo "::endgroup::"
    
    - name: STEP 4 - Submission Agent
      id: submission
      env:
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
      run: |
        echo "::group::üìù Submission Agent Output"
        python scripts/run_pipeline.py --no-train --no-detect-drift
        echo "::endgroup::"
    
    - name: Data Drift Detection
      id: drift_detection
      env:
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
      run: |
        echo "::group::üîç Data Drift Detection"
        python scripts/run_pipeline.py --detect-drift --no-train --no-submission || echo "‚ö†Ô∏è Drift failed"
        echo "::endgroup::"
    
    - name: Upload model artifact
      uses: actions/upload-artifact@v4
      with:
        name: trained-model
        path: src/models/baseline_model.pkl
        if-no-files-found: warn
    
    - name: Upload submission
      uses: actions/upload-artifact@v4
      with:
        name: submission-file
        path: submission.csv
        if-no-files-found: warn
    
    - name: Upload reports
      uses: actions/upload-artifact@v4
      with:
        name: analysis-reports
        path: |
          reports/
          data/drift_reports/
        if-no-files-found: warn
    
    - name: Summary
      if: always()
      run: |
        echo "## üìä Pipeline Execution Summary" >> $GITHUB_STEP_SUMMARY
        echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| üìä Data Loader | ${{ steps.data_loader.outcome }} |" >> $GITHUB_STEP_SUMMARY
        echo "| üìà Feature Engineer | ${{ steps.feature_engineer.outcome }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ü§ñ Model Trainer | ${{ steps.model_trainer.outcome }} |" >> $GITHUB_STEP_SUMMARY
        echo "| üìù Submission | ${{ steps.submission.outcome }} |" >> $GITHUB_STEP_SUMMARY
        echo "| üîç Drift Detection | ${{ steps.drift_detection.outcome }} |" >> $GITHUB_STEP_SUMMARY