name: Train Model

on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'scripts/**'
      - 'requirements.txt'
  schedule:
    - cron: '0 0 * * 0'  # Tous les dimanches Ã  minuit
  workflow_dispatch:  # Permet le dÃ©clenchement manuel

jobs:
  train:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Download Kaggle data
      env:
        KAGGLE_USERNAME: ${{ secrets.KAGGLE_USERNAME }}
        KAGGLE_KEY: ${{ secrets.KAGGLE_KEY }}
      run: |
        python scripts/download_data.py || echo "âš ï¸ Data download failed, but continuing if files exist locally"
    
    - name: ðŸ”· STEP 1 - Data Loader Agent
      id: data_loader
      env:
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
      run: |
        echo "::group::ðŸ“Š Data Loader Agent Output"
        python scripts/run_pipeline.py --train --no-submission || exit 1
        echo "::endgroup::"
    
    - name: ðŸ”¶ STEP 2 - Feature Engineer Agent
      id: feature_engineer
      env:
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
      run: |
        echo "::group::ðŸ“ˆ Feature Engineer Agent Output"
        # Already run in step 1, but we add a small verification
        python -c "
import pandas as pd
from pathlib import Path
if Path('src/models/').exists():
    print('âœ… Feature engineering completed successfully')
else:
    print('âš ï¸ Feature engineering may not have completed')
        "
        echo "::endgroup::"
    
    - name: ðŸ”· STEP 3 - Model Trainer Agent
      id: model_trainer
      env:
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
      run: |
        echo "::group::ðŸ¤– Model Trainer Agent Output"
        # Verify model was created
        python -c "
import joblib
from pathlib import Path
model_path = Path('src/models/baseline_model.pkl')
if model_path.exists():
    model = joblib.load(model_path)
    print(f'âœ… Model loaded successfully: {type(model).__name__}')
else:
    print('âŒ Model not found - training may have failed')
    exit(1)
        "
        echo "::endgroup::"
    
    - name: ðŸ”¶ STEP 4 - Submission Agent
      id: submission
      env:
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
      run: |
        echo "::group::ðŸ“ Submission Agent Output"
        python scripts/run_pipeline.py --no-train --no-detect-drift || exit 1
        echo "::endgroup::"
    
    - name: ðŸ“Š Data Drift Detection
      id: drift_detection
      env:
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
      run: |
        echo "::group::ðŸ” Data Drift Detection"
        python scripts/run_pipeline.py --detect-drift --no-train --no-submission || echo "âš ï¸ Drift detection failed but continuing"
        echo "::endgroup::"
    
    - name: ðŸ“¦ Upload model artifact
      uses: actions/upload-artifact@v4
      with:
        name: trained-model
        path: src/models/baseline_model.pkl
        if-no-files-found: warn
        retention-days: 30
    
    - name: ðŸ“¦ Upload submission
      uses: actions/upload-artifact@v4
      with:
        name: submission-file
        path: submission.csv
        if-no-files-found: warn
        retention-days: 30
    
    - name: ðŸ“¦ Upload reports
      uses: actions/upload-artifact@v4
      with:
        name: analysis-reports
        path: |
          reports/
          data/drift_reports/
        if-no-files-found: warn
        retention-days: 30
    
    - name: ðŸ“Š Summary
      if: always()
      run: |
        echo "## ðŸ“Š Pipeline Execution Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ”· Data Loader | ${{ steps.data_loader.outcome }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ”¶ Feature Engineer | ${{ steps.feature_engineer.outcome }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ”· Model Trainer | ${{ steps.model_trainer.outcome }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ”¶ Submission | ${{ steps.submission.outcome }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ” Drift Detection | ${{ steps.drift_detection.outcome }} |" >> $GITHUB_STEP_SUMMARY